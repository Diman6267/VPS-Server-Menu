#!/bin/bash

# ======================================================================
# –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ –ú–ï–ù–Æ (–ú–û–î–£–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø)
# ======================================================================

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
source /usr/local/bin/_config_and_utils.sh

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
function show_menu {
    clear
    echo -e "${CYAN}======================================================${NC}"
    echo -e "${CYAN}             üöÄ –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ï–†–í–ï–†–û–ú üöÄ            ${NC}"
    echo -e "${CYAN}======================================================${NC}"
    
    # --- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö ---
    UPTIME=$(uptime -p)
    
    # CPU
    if command -v lscpu &> /dev/null; then
        CPU_MODEL=$(lscpu 2>/dev/null | grep 'Model name:' | head -n 1 | awk -F ':' '{print $2}' | sed -e 's/^[ \t]*//' -e 's/([^)]*)//g' -e 's/[[:space:]]*$//')
        CPU_CORES=$(nproc)
    elif [ -f "/proc/cpuinfo" ]; then
        CPU_MODEL=$(grep 'model name' /proc/cpuinfo | head -n 1 | awk -F ':' '{print $2}' | sed -e 's/^[ \t]*//' -e 's/([^)]*)//g' -e 's/[[:space:]]*$//')
        CPU_CORES=$(grep -c processor /proc/cpuinfo)
    else
        CPU_MODEL="–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
        CPU_CORES="?"
    fi
    CPU_MODEL=${CPU_MODEL:-–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ}
    CPU_CORES=${CPU_CORES:-1}
    
    # RAM
    RAM_TOTAL_RAW=$(grep MemTotal /proc/meminfo | awk '{print $2/1024/1048}') # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ 1048576 (1024*1024)
    RAM_TOTAL=$(printf "%.1f" $RAM_TOTAL_RAW)
    MEM_FREE=$(grep MemAvailable /proc/meminfo | awk '{print $2/1024/1048}')
    MEM_USED=$(echo "$RAM_TOTAL - $MEM_FREE" | bc -l)
    MEM_PERCENT=$(echo "$MEM_USED * 100 / $RAM_TOTAL" | bc -l | awk '{printf "%.0f", $1}')
    MEM_DISPLAY=$(printf "%.1f/%.1f GB (%.0f%%)" $MEM_USED $RAM_TOTAL $MEM_PERCENT)
    
    # IP CHECK
    PUBLIC_IPV4=$(curl -s4 ipinfo.io/ip 2>/dev/null)
    if [ -z "$PUBLIC_IPV4" ]; then PUBLIC_IPV4="–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"; fi

    PUBLIC_IPV6=$(get_public_ipv6)
   
    CPU_LOAD=$(grep 'cpu ' /proc/stat | awk '{print ($2+$4)*100/($2+$4+$5)}' | awk '{printf "%.2f%%", $1}')
    DISK_USAGE=$(df -h --output=used,avail,pcent / | tail -n 1)
    read -r USED AVAIL PCT <<< "$DISK_USAGE"

    echo -e "${BLUE}--- –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –ò –°–¢–ê–¢–£–° –°–ï–†–í–ï–†–ê ------------------${NC}"
    echo -e "${YELLOW}    CPU:             ${GREEN}$CPU_MODEL ($CPU_CORES core)${NC}"
    echo -e "${YELLOW}    RAM (–ù–∞–≥—Ä—É–∑–∫–∞):  ${GREEN}$MEM_DISPLAY${NC}"
    echo -e "${YELLOW}    –ü—É–±–ª–∏—á–Ω—ã–π IPv4:  ${GREEN}$PUBLIC_IPV4${NC}"
    echo -e "${YELLOW}    –ü—É–±–ª–∏—á–Ω—ã–π IPv6:  ${PUBLIC_IPV6}${NC}"
    echo -e "${YELLOW}    –ê–ø—Ç–∞–π–º:          ${GREEN}$UPTIME${NC}"
    echo -e "${YELLOW}    CPU (–ù–∞–≥—Ä—É–∑–∫–∞):  ${GREEN}$CPU_LOAD${NC}"
    echo -e "${YELLOW}    –î–∏—Å–∫ (–∫–æ—Ä–µ–Ω—å):   ${GREEN}–ó–∞–Ω—è—Ç–æ:$USED ($PCT) | –°–≤–æ–±–æ–¥–Ω–æ:$AVAIL${NC}"
    echo -e "${BLUE}------------------------------------------------------${NC}"
    
    # –°–¢–ê–¢–£–° –ü–†–ò–õ–û–ñ–ï–ù–ò–ô
    echo -e "${BLUE}--- –°–¢–ê–¢–£–° –ü–†–ò–õ–û–ñ–ï–ù–ò–ô --------------------------------${NC}"
    STATUS_XUI=$(get_service_status $XUI_SERVICE)
    STATUS_HYS=$(get_service_status $HYSTERIA_SERVICE)
    
    echo -e "    X-UI:        [$(if [ "$STATUS_XUI" == "active" ]; then echo -e "${GREEN}–†–ê–ë–û–¢–ê–ï–¢${NC}"; else echo -e "${RED}–û–°–¢–ê–ù–û–í–õ–ï–ù${NC}"; fi)]"
    echo -e "    Hysteria2:   [$(if [ "$STATUS_HYS" == "active" ]; then echo -e "${GREEN}–†–ê–ë–û–¢–ê–ï–¢${NC}"; else echo -e "${RED}–û–°–¢–ê–ù–û–í–õ–ï–ù${NC}"; fi)]"
    
    echo -e "${BLUE}--- –î–ï–ô–°–¢–í–ò–Ø ---------------------------------------${NC}"
    echo -e "${YELLOW}1) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ X-UI (–£—Å—Ç–∞–Ω–æ–≤–∫–∞/–ó–∞–ø—É—Å–∫/–ù–∞—Å—Ç—Ä–æ–π–∫–∞)${NC}"
    echo -e "${YELLOW}2) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Hysteria2 (–£—Å—Ç–∞–Ω–æ–≤–∫–∞/–°—Ç–∞—Ä—Ç/–°—Ç–æ–ø/–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)${NC}"
    echo -e "${YELLOW}3) –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ (–°–∫–æ—Ä–æ—Å—Ç—å/–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏/–°–∫–∞–Ω–µ—Ä)${NC}"
    echo -e "${YELLOW}4) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞${NC}"
    echo -e "${GREEN}5) –ú–µ–Ω—é IPv6 (–í–∫–ª/–í—ã–∫–ª/–°—Ç–∞—Ç—É—Å)${NC}"
    echo -e "${CYAN}6) üîÑ –û–ë–ù–û–í–ò–¢–¨ –°–ö–†–ò–ü–¢–´ (—Å GitHub)${NC}"
    echo -e "${RED}X) –í—ã—Ö–æ–¥ –≤ –æ–±–æ–ª–æ—á–∫—É${NC}"
    echo -e "${BLUE}------------------------------------------------------${NC}"
}

# –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –ó–ê–ü–£–°–ö–ê - –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—ã
while true; do
    show_menu
    PROMPT=$(echo -e "${CYAN}–í–∞—à –≤—ã–±–æ—Ä [1-5, X]: ${NC}")
    read -p "$PROMPT" choice

    case $choice in
        1) /usr/local/bin/menu_xui.sh ;;
        2) /usr/local/bin/menu_hysteria.sh ;;
        3) /usr/local/bin/menu_tests.sh ;;
        4) /usr/local/bin/menu_setup.sh ;;
        5) /usr/local/bin/ipv6-menu ;;
        6)
           echo -e "${YELLOW}>>> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤...${NC}"
           bash <(curl -sL https://raw.githubusercontent.com/Diman6267/VPS-Server-Menu/main/install.sh)
           exit 0 
           ;;
        [Xx])                                   
            echo -e "${GREEN}–í—ã—Ö–æ–¥ –≤ –æ–±–æ–ª–æ—á–∫—É.${NC}"
            break
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥.${NC}"
            sleep 1
            ;;
    esac
done

#!/bin/bash

# ======================================================================
# –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ –ú–ï–ù–Æ (–ú–û–î–£–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø)
# ======================================================================

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
source /usr/local/bin/_config_and_utils.sh

# --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
function show_menu {
    clear
    echo -e "${CYAN}======================================================${NC}"
    echo -e "${CYAN}             üöÄ –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ï–†–í–ï–†–û–ú üöÄ            ${NC}"
    echo -e "${CYAN}======================================================${NC}"
    
    # --- –ë–õ–û–ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö ---
    # --- –°–ë–û–† –î–ê–ù–ù–´–• –í –°–¢–ò–õ–ï BENCH.SH ---
    # CPU
    if command -v lscpu &> /dev/null; then
        CPU_MODEL=$(lscpu 2>/dev/null | grep 'Model name:' | head -n 1 | awk -F ':' '{print $2}' | sed -e 's/^[ \t]*//')
        CPU_CORES=$(nproc)
        CPU_FREQ=$(lscpu | grep -i "CPU MHz" | awk -F': ' '{print $2}' | xargs)
		if [ -z "$CPU_FREQ" ]; then
    CPU_FREQ=$(grep -m1 "cpu MHz" /proc/cpuinfo | awk -F': ' '{print $2}' | xargs)
fi
        CPU_CACHE=$(lscpu | grep "L3 cache" | awk '{print $3$4}')
    else
        CPU_MODEL="–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"; CPU_CORES="?"; CPU_FREQ="?"; CPU_CACHE="?"
    fi

    # AES-NI / Virtualization
    AES_NI=$(grep -qw aes /proc/cpuinfo && echo -e "${GREEN}‚úì –í–∫–ª—é—á–µ–Ω–æ${NC}" || echo -e "${RED}‚úó –í—ã–∫–ª—é—á–µ–Ω–æ${NC}")
    VM_X=$(grep -Eow "vmx|svm" /proc/cpuinfo > /dev/null && echo -e "${GREEN}‚úì –í–∫–ª—é—á–µ–Ω–æ${NC}" || echo -e "${RED}‚úó –í—ã–∫–ª—é—á–µ–Ω–æ${NC}")
    VIRT=$(systemd-detect-virt 2>/dev/null || echo "Unknown")

    # DISK & MEM (–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã —Å bc) [cite: 8]
    RAM_TOTAL_RAW=$(grep MemTotal /proc/meminfo | awk '{print $2/1024/1024}')
    RAM_TOTAL=$(printf "%.1f" $RAM_TOTAL_RAW)
    MEM_FREE=$(grep MemAvailable /proc/meminfo | awk '{print $2/1024/1024}')
    MEM_USED=$(echo "$RAM_TOTAL - $MEM_FREE" | bc -l)
    
    DISK_USAGE=$(df -h --output=size,used / | tail -n 1)
    read -r D_TOTAL D_USED <<< "$DISK_USAGE"

    # SYSTEM INFO
    UPTIME_RAW=$(uptime -p | sed 's/up //')
    UPTIME=$(echo "$UPTIME_RAW" | sed -e 's/years\?/–ª–µ—Ç/g' -e 's/weeks\?/–Ω–µ–¥–µ–ª—å/g' -e 's/days\?/–¥–Ω./g' -e 's/hours\?/—á–∞—Å./g' -e 's/minutes\?/–º–∏–Ω./g')
    LOAD_AVG=$(awk '{print $1", "$2", "$3}' /proc/loadavg)
    OS_NAME=$(grep "PRETTY_NAME" /etc/os-release | cut -d'"' -f2)
    ARCH=$(uname -m)
    KERNEL=$(uname -r)
    TCP_CC=$(sysctl net.ipv4.tcp_congestion_control | awk '{print $3}')

    # NETWORK & GEO 
    IPV4=$(curl -s4 ipinfo.io/ip 2>/dev/null || echo -e "${RED}‚úó Offline${NC}")
    IPV6=$(get_public_ipv6)
    GEO_DATA=$(curl -s "http://ip-api.com/json/$PUBLIC_IPV4?lang=ru&fields=status,message,country,regionName,city,isp,org,as")
    COUNTRY=$(echo "$GEO_DATA" | jq -r '.country' 2>/dev/null || echo "$GEO_DATA" | grep -oP '"country":"\K[^"]+')
    LOC=$(echo "$GEO_DATA" | jq -r '.city' 2>/dev/null || echo "$GEO_DATA" | grep -oP '"city":"\K[^"]+')
    REG=$(echo "$GEO_DATA" | jq -r '.regionName' 2>/dev/null || echo "$GEO_DATA" | grep -oP '"regionName":"\K[^"]+')
    ORG=$(echo "$GEO_DATA" | jq -r '.org' 2>/dev/null || echo "$GEO_DATA" | grep -oP '"org":"\K[^"]+')
    if [ -z "$ORG" ] || [ "$ORG" == "null" ]; then
        ORG=$(echo "$GEO_DATA" | jq -r '.isp' 2>/dev/null || echo "$GEO_DATA" | grep -oP '"isp":"\K[^"]+')
    fi
    # --- –í–´–í–û–î –ú–ï–ù–Æ –í –°–¢–ò–õ–ï BENCH.SH ---
    echo -e "${BLUE}----------------------------------------------------------------------${NC}"
    echo -e " –ú–æ–¥–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞   : ${YELLOW}$CPU_MODEL${NC}"
    echo -e " –Ø–¥—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞     : ${YELLOW}$CPU_CORES @ ${CPU_FREQ} MHz${NC}"
    echo -e " –ö—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞      : ${YELLOW}$CPU_CACHE${NC}"
    echo -e " AES-NI              : $AES_NI"
    echo -e " VM-x/AMD-V          : $VM_X"
    echo -e " –í—Å–µ–≥–æ –¥–∏—Å–∫–∞         : ${YELLOW}$D_TOTAL ($D_USED –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)${NC}"
    echo -e " –í—Å–µ–≥–æ –ø–∞–º—è—Ç–∏        : ${YELLOW}$RAM_TOTAL GB ($(printf "%.1f" $MEM_USED) GB –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)${NC}"
    echo -e " –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã        : ${YELLOW}$UPTIME${NC}"
    echo -e " –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞    : ${YELLOW}$LOAD_AVG${NC}"
    echo -e " –û–°                  : ${YELLOW}$OS_NAME${NC}"
    echo -e " –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞         : ${YELLOW}$ARCH (64 Bit)${NC}"
    echo -e " –Ø–¥—Ä–æ                : ${YELLOW}$KERNEL${NC}"
    echo -e " TCP CC              : ${YELLOW}$TCP_CC${NC}"
    echo -e " –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è       : ${YELLOW}$VIRT${NC}"
    echo -e " IPv4 / IPv6         : ${GREEN}$IPV4${NC} / ${GREEN}${IPV6}${NC}"
    echo -e " –°—Ç—Ä–∞–Ω–∞              : ${YELLOW}$COUNTRY${NC}"
    echo -e " –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è         : ${YELLOW}$ORG${NC}"
    echo -e " –õ–æ–∫–∞—Ü–∏—è             : ${YELLOW}$LOC${NC}"
    echo -e " –†–µ–≥–∏–æ–Ω              : ${YELLOW}$REG${NC}"
    echo -e "${BLUE}----------------------------------------------------------------------${NC}"
    
    # –°–¢–ê–¢–£–° –ü–†–ò–õ–û–ñ–ï–ù–ò–ô
    echo -e "${BLUE}--- –°–¢–ê–¢–£–° –ü–†–ò–õ–û–ñ–ï–ù–ò–ô --------------------------------${NC}"
    STATUS_XUI=$(get_service_status $XUI_SERVICE)
    STATUS_HYS=$(get_service_status $HYSTERIA_SERVICE)
    
    echo -e "    X-UI:        [$(if [ "$STATUS_XUI" == "active" ]; then echo -e "${GREEN}–†–ê–ë–û–¢–ê–ï–¢${NC}"; else echo -e "${RED}–û–°–¢–ê–ù–û–í–õ–ï–ù${NC}"; fi)]"
    echo -e "    Hysteria2:   [$(if [ "$STATUS_HYS" == "active" ]; then echo -e "${GREEN}–†–ê–ë–û–¢–ê–ï–¢${NC}"; else echo -e "${RED}–û–°–¢–ê–ù–û–í–õ–ï–ù${NC}"; fi)]"
    
    echo -e "${BLUE}--- –î–ï–ô–°–¢–í–ò–Ø ---------------------------------------${NC}"
    echo -e "${YELLOW}1) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ X-UI (–£—Å—Ç–∞–Ω–æ–≤–∫–∞/–ó–∞–ø—É—Å–∫/–ù–∞—Å—Ç—Ä–æ–π–∫–∞)${NC}"
    echo -e "${YELLOW}2) –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Hysteria2 (–£—Å—Ç–∞–Ω–æ–≤–∫–∞/–°—Ç–∞—Ä—Ç/–°—Ç–æ–ø/–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)${NC}"
    echo -e "${YELLOW}3) –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ (–°–∫–æ—Ä–æ—Å—Ç—å/–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏/–°–∫–∞–Ω–µ—Ä)${NC}"
    echo -e "${YELLOW}4) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞${NC}"
    echo -e "${GREEN}5) –ú–µ–Ω—é IPv6 (–í–∫–ª/–í—ã–∫–ª/–°—Ç–∞—Ç—É—Å)${NC}"
    echo -e "${CYAN}6) üîÑ –û–ë–ù–û–í–ò–¢–¨ –°–ö–†–ò–ü–¢–´ (—Å GitHub)${NC}"
    echo -e "${RED}X) –í—ã—Ö–æ–¥ –≤ –æ–±–æ–ª–æ—á–∫—É${NC}"
    echo -e "${BLUE}------------------------------------------------------${NC}"
}

# –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –ó–ê–ü–£–°–ö–ê - –≤—ã–∑—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—ã
while true; do
    show_menu
    PROMPT=$(echo -e "${CYAN}–í–∞—à –≤—ã–±–æ—Ä [1-5, X]: ${NC}")
    read -p "$PROMPT" choice

    case $choice in
        1) /usr/local/bin/menu_xui.sh ;;
        2) /usr/local/bin/menu_hysteria.sh ;;
        3) /usr/local/bin/menu_tests.sh ;;
        4) /usr/local/bin/menu_setup.sh ;;
        5) /usr/local/bin/ipv6-menu ;;
        6)
           echo -e "${YELLOW}>>> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤...${NC}"
           bash <(curl -sL https://raw.githubusercontent.com/Diman6267/VPS-Server-Menu/main/install.sh)
           exit 0 
           ;;
        [Xx])                                   
            echo -e "${GREEN}–í—ã—Ö–æ–¥ –≤ –æ–±–æ–ª–æ—á–∫—É.${NC}"
            break
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥.${NC}"
            sleep 1
            ;;
    esac
done
